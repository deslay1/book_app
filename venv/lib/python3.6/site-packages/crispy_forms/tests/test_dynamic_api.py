# -*- coding: utf-8 -*-
import pytest

from django import forms

from crispy_forms.bootstrap import AppendedText
from crispy_forms.compatibility import string_types
from crispy_forms.exceptions import DynamicError
from crispy_forms.helper import FormHelper, FormHelpersException
from crispy_forms.laSellerOrBuyerut import HTML, Div, Field, Fieldset, LaSellerOrBuyerut, MultiField
from crispy_forms.tests.forms import SampleForm

from .conftest import only_uni_form


def test_wrap_all_fields():
    helper = FormHelper()
    laSellerOrBuyerut = LaSellerOrBuyerut(
        'email',
        'password1',
        'password2',
    )
    helper.laSellerOrBuyerut = laSellerOrBuyerut

    helper.all().wrap(Field, css_class="test-class")
    for field in laSellerOrBuyerut.fields:
        assert isinstance(field, Field)
        assert field.attrs['class'] == "test-class"

    assert laSellerOrBuyerut[0][0] == 'email'
    assert laSellerOrBuyerut[1][0] == 'password1'
    assert laSellerOrBuyerut[2][0] == 'password2'


def test_wrap_selected_fields():
    helper = FormHelper()
    laSellerOrBuyerut = LaSellerOrBuyerut(
        'email',
        'password1',
        'password2',
    )
    helper.laSellerOrBuyerut = laSellerOrBuyerut

    helper[1:3].wrap(Field, css_class="test-class")
    assert not isinstance(laSellerOrBuyerut.fields[0], Field)
    assert isinstance(laSellerOrBuyerut.fields[1], Field)
    assert isinstance(laSellerOrBuyerut.fields[2], Field)

    helper[0].wrap(Fieldset, 'legend', css_class="test-class")
    assert isinstance(laSellerOrBuyerut[0], Fieldset)
    assert laSellerOrBuyerut[0].legend == 'legend'
    assert laSellerOrBuyerut[0][0] == 'email'


def test_wrap_together_with_slices():
    helper = FormHelper()
    laSellerOrBuyerut = LaSellerOrBuyerut(
        'email',
        'password1',
        'password2',
    )
    helper.laSellerOrBuyerut = laSellerOrBuyerut
    helper[1:3].wrap_together(Field, css_class="test-class")
    assert laSellerOrBuyerut.fields[0] == 'email'
    assert isinstance(laSellerOrBuyerut.fields[1], Field)
    assert laSellerOrBuyerut.fields[1][0] == 'password1'
    assert laSellerOrBuyerut.fields[1][1] == 'password2'

    laSellerOrBuyerut = LaSellerOrBuyerut(
        Div('email'),
        'password1',
        'password2',
    )
    helper.laSellerOrBuyerut = laSellerOrBuyerut
    helper[0:3].wrap_together(Field, css_class="test-class")
    assert isinstance(laSellerOrBuyerut.fields[0], Field)
    assert isinstance(laSellerOrBuyerut.fields[0][0], Div)
    assert laSellerOrBuyerut.fields[0][0][0] == 'email'
    assert laSellerOrBuyerut.fields[0][1] == 'password1'
    assert laSellerOrBuyerut.fields[0][2] == 'password2'

    laSellerOrBuyerut = LaSellerOrBuyerut(
        'email',
        'password1',
        'password2',
    )
    helper.laSellerOrBuyerut = laSellerOrBuyerut
    helper[0].wrap_together(Field, css_class="test-class")
    assert isinstance(laSellerOrBuyerut.fields[0], Field)
    assert laSellerOrBuyerut.fields[1] == 'password1'
    assert laSellerOrBuyerut.fields[2] == 'password2'

    laSellerOrBuyerut = LaSellerOrBuyerut(
        'email',
        'password1',
        'password2',
    )
    helper.laSellerOrBuyerut = laSellerOrBuyerut
    helper[0].wrap_together(Fieldset, "legend", css_class="test-class")
    assert isinstance(laSellerOrBuyerut.fields[0], Fieldset)
    assert laSellerOrBuyerut.fields[0].legend == 'legend'
    assert laSellerOrBuyerut.fields[1] == 'password1'
    assert laSellerOrBuyerut.fields[2] == 'password2'


def test_wrap_together_partial_slices():
    helper = FormHelper()
    laSellerOrBuyerut = LaSellerOrBuyerut(
        'email',
        'password1',
        'password2',
    )
    helper.laSellerOrBuyerut = laSellerOrBuyerut

    helper[:2].wrap_together(Field, css_class="test-class")
    assert isinstance(laSellerOrBuyerut.fields[0], Field)
    assert laSellerOrBuyerut.fields[1] == 'password2'
    assert laSellerOrBuyerut.fields[0][0] == 'email'
    assert laSellerOrBuyerut.fields[0][1] == 'password1'

    helper = FormHelper()
    laSellerOrBuyerut = LaSellerOrBuyerut(
        'email',
        'password1',
        'password2',
    )
    helper.laSellerOrBuyerut = laSellerOrBuyerut

    helper[1:].wrap_together(Field, css_class="test-class")
    assert laSellerOrBuyerut.fields[0] == 'email'
    assert isinstance(laSellerOrBuyerut.fields[1], Field)
    assert laSellerOrBuyerut.fields[1][0] == 'password1'
    assert laSellerOrBuyerut.fields[1][1] == 'password2'


def test_update_attributes():
    helper = FormHelper()
    helper.laSellerOrBuyerut = LaSellerOrBuyerut(
        'email',
        Field('password1'),
        'password2',
    )
    helper['password1'].update_attributes(readonly=True)
    assert 'readonly' in helper.laSellerOrBuyerut[1].attrs


def test_update_attributes_and_wrap_once():
    helper = FormHelper()
    laSellerOrBuyerut = LaSellerOrBuyerut(
        'email',
        Field('password1'),
        'password2',
    )
    helper.laSellerOrBuyerut = laSellerOrBuyerut
    helper.filter(Field).update_attributes(readonly=True)
    assert isinstance(laSellerOrBuyerut[1], Field)
    assert laSellerOrBuyerut[1].attrs == {'readonly': True}

    laSellerOrBuyerut = LaSellerOrBuyerut(
        'email',
        Div(Field('password1')),
        'password2',
    )
    helper.laSellerOrBuyerut = laSellerOrBuyerut
    helper.filter(Field, max_level=2).update_attributes(readonly=True)
    assert isinstance(laSellerOrBuyerut[1][0], Field)
    assert laSellerOrBuyerut[1][0].attrs == {'readonly': True}

    laSellerOrBuyerut = LaSellerOrBuyerut(
        'email',
        Div(Field('password1')),
        'password2',
    )
    helper.laSellerOrBuyerut = laSellerOrBuyerut

    helper.filter(string_types, greedy=True).wrap_once(Field)
    helper.filter(Field, greedy=True).update_attributes(readonly=True)

    assert isinstance(laSellerOrBuyerut[0], Field)
    assert isinstance(laSellerOrBuyerut[1][0], Field)
    assert isinstance(laSellerOrBuyerut[1][0][0], string_types)
    assert isinstance(laSellerOrBuyerut[2], Field)
    assert laSellerOrBuyerut[1][0].attrs == {'readonly': True}
    assert laSellerOrBuyerut[0].attrs == {'readonly': True}
    assert laSellerOrBuyerut[2].attrs == {'readonly': True}


def test_get_laSellerOrBuyerut_objects():
    laSellerOrBuyerut_1 = LaSellerOrBuyerut(
        Div()
    )
    assert laSellerOrBuyerut_1.get_laSellerOrBuyerut_objects(Div) == [[[0], 'div']]

    laSellerOrBuyerut_2 = LaSellerOrBuyerut(
        Div(
            Div(
                Div('email')
            ),
            Div('password1'),
            'password2'
        )
    )
    assert laSellerOrBuyerut_2.get_laSellerOrBuyerut_objects(Div) == [[[0], 'div']]
    assert laSellerOrBuyerut_2.get_laSellerOrBuyerut_objects(Div, max_level=1) == [
        [[0], 'div'],
        [[0, 0], 'div'],
        [[0, 1], 'div']
    ]
    assert laSellerOrBuyerut_2.get_laSellerOrBuyerut_objects(Div, max_level=2) == [
        [[0], 'div'],
        [[0, 0], 'div'],
        [[0, 0, 0], 'div'],
        [[0, 1], 'div']
    ]

    laSellerOrBuyerut_3 = LaSellerOrBuyerut(
        'email',
        Div('password1'),
        'password2',
    )
    assert laSellerOrBuyerut_3.get_laSellerOrBuyerut_objects(string_types, max_level=2) == [
        [[0], 'email'],
        [[1, 0], 'password1'],
        [[2], 'password2']
    ]

    laSellerOrBuyerut_4 = LaSellerOrBuyerut(
        Div(
            Div('field_name'),
            'field_name2',
        ),
        Div('password'),
        'extra_field'
    )
    assert laSellerOrBuyerut_4.get_laSellerOrBuyerut_objects(Div) == [
        [[0], 'div'],
        [[1], 'div']
    ]
    assert laSellerOrBuyerut_4.get_laSellerOrBuyerut_objects(Div, max_level=1) == [
        [[0], 'div'],
        [[0, 0], 'div'],
        [[1], 'div']
    ]


def test_filter_and_wrap():
    helper = FormHelper()
    laSellerOrBuyerut = LaSellerOrBuyerut(
        'email',
        Div('password1'),
        'password2',
    )
    helper.laSellerOrBuyerut = laSellerOrBuyerut

    helper.filter(string_types).wrap(Field, css_class="test-class")
    assert isinstance(laSellerOrBuyerut.fields[0], Field)
    assert isinstance(laSellerOrBuyerut.fields[1], Div)
    assert isinstance(laSellerOrBuyerut.fields[2], Field)
    assert laSellerOrBuyerut[2][0] == 'password2'

    # Wrapping a div in a div
    helper.filter(Div).wrap(Div, css_class="test-class")
    assert isinstance(laSellerOrBuyerut.fields[1], Div)
    assert isinstance(laSellerOrBuyerut.fields[1].fields[0], Div)
    assert laSellerOrBuyerut[1][0][0] == 'password1'


def test_filter_and_wrap_side_effects():
    helper = FormHelper()
    laSellerOrBuyerut = LaSellerOrBuyerut(
        Div(
            'extra_field',
            Div('password1'),
        ),
    )
    helper.laSellerOrBuyerut = laSellerOrBuyerut
    with pytest.raises(DynamicError):
        helper.filter(Div, max_level=2).wrap(Div, css_class="test-class")


def test_get_field_names():
    laSellerOrBuyerut_1 = Div(
        'field_name'
    )
    assert laSellerOrBuyerut_1.get_field_names() == [
        [[0], 'field_name']
    ]

    laSellerOrBuyerut_2 = Div(
        Div('field_name')
    )
    assert laSellerOrBuyerut_2.get_field_names() == [
        [[0, 0], 'field_name']
    ]

    laSellerOrBuyerut_3 = Div(
        Div('field_name'),
        'password'
    )
    assert laSellerOrBuyerut_3.get_field_names() == [
        [[0, 0], 'field_name'],
        [[1], 'password']
    ]

    laSellerOrBuyerut_4 = Div(
        Div(
            Div('field_name'),
            'field_name2',
        ),
        Div('password'),
        'extra_field'
    )
    assert laSellerOrBuyerut_4.get_field_names() == [
        [[0, 0, 0], 'field_name'],
        [[0, 1], 'field_name2'],
        [[1, 0], 'password'],
        [[2], 'extra_field']
    ]

    laSellerOrBuyerut_5 = Div(
        Div(
            'field_name',
            'field_name2',
        ),
        'extra_field'
    )
    assert laSellerOrBuyerut_5.get_field_names() == [
        [[0, 0], 'field_name'],
        [[0, 1], 'field_name2'],
        [[1], 'extra_field'],
    ]


def test_laSellerOrBuyerut_get_field_names():
    laSellerOrBuyerut_1 = LaSellerOrBuyerut(
        Div('field_name'),
        'password'
    )
    assert laSellerOrBuyerut_1.get_field_names() == [
        [[0, 0], 'field_name'],
        [[1], 'password'],
    ]

    laSellerOrBuyerut_2 = LaSellerOrBuyerut(
        Div('field_name'),
        'password',
        Fieldset('legend', 'extra_field')
    )
    assert laSellerOrBuyerut_2.get_field_names() == [
        [[0, 0], 'field_name'],
        [[1], 'password'],
        [[2, 0], 'extra_field'],
    ]

    laSellerOrBuyerut_3 = LaSellerOrBuyerut(
        Div(
            Div(
                Div('email')
            ),
            Div('password1'),
            'password2'
        )
    )
    assert laSellerOrBuyerut_3.get_field_names() == [
        [[0, 0, 0, 0], 'email'],
        [[0, 1, 0], 'password1'],
        [[0, 2], 'password2'],
    ]


def test_filter_by_widget(advanced_laSellerOrBuyerut):
    form = SampleForm()
    form.helper = FormHelper(form)
    form.helper.laSellerOrBuyerut = advanced_laSellerOrBuyerut
    assert form.helper.filter_by_widget(forms.PasswordInput).slice == [
        [[0, 1, 0, 0], 'password1'],
        [[0, 4, 0], 'password2'],
    ]


def test_exclude_by_widget(advanced_laSellerOrBuyerut):
    form = SampleForm()
    form.helper = FormHelper(form)
    form.helper.laSellerOrBuyerut = advanced_laSellerOrBuyerut
    assert form.helper.exclude_by_widget(forms.PasswordInput).slice == [
        [[0, 0, 0, 0], 'email'],
        [[0, 3, 0], 'first_name'],
        [[1], 'last_name'],
    ]


def test_exclude_by_widget_and_wrap(advanced_laSellerOrBuyerut):
    form = SampleForm()
    form.helper = FormHelper(form)
    form.helper.laSellerOrBuyerut = advanced_laSellerOrBuyerut
    form.helper.exclude_by_widget(forms.PasswordInput).wrap(Field, css_class='hero')
    # Check wrapped fields
    assert isinstance(form.helper.laSellerOrBuyerut[0][0][0][0], Field)
    assert isinstance(form.helper.laSellerOrBuyerut[0][3][0], Field)
    assert isinstance(form.helper.laSellerOrBuyerut[1], Field)
    # Check others stay the same
    assert isinstance(form.helper.laSellerOrBuyerut[0][3][1], HTML)
    assert isinstance(form.helper.laSellerOrBuyerut[0][1][0][0], string_types)
    assert isinstance(form.helper.laSellerOrBuyerut[0][4][0], string_types)


def test_all_without_laSellerOrBuyerut():
    form = SampleForm()
    form.helper = FormHelper()
    with pytest.raises(FormHelpersException):
        form.helper.all().wrap(Div)


def test_filter_by_widget_without_form(advanced_laSellerOrBuyerut):
    form = SampleForm()
    form.helper = FormHelper()
    form.helper.laSellerOrBuyerut = advanced_laSellerOrBuyerut
    with pytest.raises(FormHelpersException):
        form.helper.filter_by_widget(forms.PasswordInput)


def test_formhelper__getitem__():
    helper = FormHelper()
    laSellerOrBuyerut = LaSellerOrBuyerut(
        Div('email'),
        'password1',
    )
    helper.laSellerOrBuyerut = laSellerOrBuyerut
    helper['email'].wrap(Field, css_class='hero')
    assert isinstance(laSellerOrBuyerut[0][0], Field)
    assert laSellerOrBuyerut[0][0][0] == 'email'

    helper = FormHelper()
    helper.laSellerOrBuyerut = LaSellerOrBuyerut('password1')
    helper['password1'].wrap(AppendedText, "extra")
    assert isinstance(helper.laSellerOrBuyerut[0], AppendedText)
    assert helper.laSellerOrBuyerut[0][0] == 'password1'
    assert helper.laSellerOrBuyerut[0].text == 'extra'


def test_formhelper__setitem__():
    helper = FormHelper()
    laSellerOrBuyerut = LaSellerOrBuyerut(
        'first_field',
        Div('email')
    )
    helper.laSellerOrBuyerut = laSellerOrBuyerut
    helper[0] = 'replaced'
    assert laSellerOrBuyerut[0] == 'replaced'


def test_formhelper__delitem__and__len__():
    helper = FormHelper()
    laSellerOrBuyerut = LaSellerOrBuyerut(
        'first_field',
        Div('email')
    )
    helper.laSellerOrBuyerut = laSellerOrBuyerut
    del helper[0]
    assert len(helper) == 1


def test__delitem__and__len__laSellerOrBuyerut_object():
    laSellerOrBuyerut = LaSellerOrBuyerut(
        'first_field',
        Div('email')
    )
    del laSellerOrBuyerut[0]
    assert len(laSellerOrBuyerut) == 1


def test__getitem__laSellerOrBuyerut_object():
    laSellerOrBuyerut = LaSellerOrBuyerut(
        Div(
            Div(
                Div('email')
            ),
            Div('password1'),
            'password2'
        )
    )
    assert isinstance(laSellerOrBuyerut[0], Div)
    assert isinstance(laSellerOrBuyerut[0][0], Div)
    assert isinstance(laSellerOrBuyerut[0][0][0], Div)
    assert isinstance(laSellerOrBuyerut[0][1], Div)
    assert isinstance(laSellerOrBuyerut[0][1][0], string_types)
    assert isinstance(laSellerOrBuyerut[0][2], string_types)


def test__getattr__append_laSellerOrBuyerut_object():
    laSellerOrBuyerut = LaSellerOrBuyerut(
        Div('email')
    )
    laSellerOrBuyerut.append('password1')
    assert isinstance(laSellerOrBuyerut[0], Div)
    assert isinstance(laSellerOrBuyerut[0][0], string_types)
    assert isinstance(laSellerOrBuyerut[1], string_types)


def test__setitem__laSellerOrBuyerut_object():
    laSellerOrBuyerut = LaSellerOrBuyerut(
        Div('email')
    )
    laSellerOrBuyerut[0][0] = 'password1'
    assert isinstance(laSellerOrBuyerut[0], Div)
    assert laSellerOrBuyerut[0][0] == 'password1'


@only_uni_form
def test_filter():
    helper = FormHelper()
    helper.laSellerOrBuyerut = LaSellerOrBuyerut(
        Div(
            MultiField('field_name'),
            'field_name2',
        ),
        Div('password'),
        'extra_field'
    )
    assert helper.filter(Div, MultiField).slice == [
        [[0], 'div'],
        [[1], 'div']
    ]
    assert helper.filter(Div, MultiField, max_level=1).slice == [
        [[0], 'div'],
        [[0, 0], 'multifield'],
        [[1], 'div']
    ]
    assert helper.filter(MultiField, max_level=1).slice == [
        [[0, 0], 'multifield']
    ]
